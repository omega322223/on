<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running Tier Master (Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; padding-top: 70px; padding-bottom: 100px; }
        
        /* --- ÏÉÅÎã® Í≥†Ï†ï Ìà¥Î∞î --- */
        #top-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: white; border-bottom: 1px solid #e5e7eb;
            display: flex; align-items: center; justify-content: space-between;
            z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 0 20px;
        }
        .app-title { font-weight: 900; font-size: 18px; font-style: italic; color: #1f2937; }
        .app-title span { color: #2563eb; }
        
        .toolbar-group { display: flex; gap: 8px; border-right: 1px solid #e5e7eb; padding-right: 15px; margin-right: 15px; align-items: center; }
        .toolbar-group:last-child { border: none; }
        
        .icon-btn {
            width: 36px; height: 36px; border-radius: 6px; border: 1px solid transparent;
            background: transparent; color: #4b5563; font-size: 14px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .icon-btn:hover { background: #f3f4f6; color: #111; }
        .icon-btn:active { background: #e5e7eb; transform: scale(0.95); }
        .icon-btn.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        
        /* --- Î©îÏù∏ ÌÖåÏù¥Î∏î --- */
        #capture-container { padding: 40px; background: white; display: inline-block; min-width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        table { border-collapse: collapse; width: 100%; table-layout: fixed; }
        th, td { border: 1px solid #cbd5e1; position: relative; vertical-align: top; padding: 0; transition: border 0.1s; }
        
        /* ÏÖÄ ÏÑ†ÌÉù Ìö®Í≥º */
        td.selected, th.selected { outline: 2px solid #2563eb; outline-offset: -2px; z-index: 10; background-color: rgba(37, 99, 235, 0.05); }

        /* ÏûÖÎ†•Ï∞Ω */
        .cell-input { width: 100%; background: transparent; text-align: center; outline: none; border: none; }
        .head-input { font-weight: 900; text-transform: uppercase; font-size: 14px; padding: 12px 4px; color: inherit; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .model-name { font-weight: 700; font-size: 13px; color: #1e293b; margin-top: 6px; }
        .model-desc { font-size: 11px; color: #64748b; margin-bottom: 6px; }

        /* Ïù¥ÎØ∏ÏßÄ ÎìúÎûòÍ∑∏ ÏòÅÏó≠ */
        .image-drop-zone {
            width: 90%; height: 60px;
            border: 2px dashed #e2e8f0; border-radius: 6px; margin: 6px auto;
            display: flex; justify-content: center; align-items: center;
            background-color: #f8fafc; color: #94a3b8; font-size: 10px;
            position: relative; overflow: hidden;
        }
        .uploaded-image { width: 100%; height: 100%; object-fit: contain; background: white; display: none; }
        .image-drop-zone.has-image .uploaded-image { display: block; }
        .image-drop-zone.has-image .placeholder-text { display: none; }
        .image-drop-zone.has-image { border: none; background: transparent; }
        .remove-img-btn { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.5); color: white; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; display: none; }
        .image-drop-zone.has-image:hover .remove-img-btn { display: flex; }

        /* --- ÌîåÎ°úÌåÖ Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥ --- */
        #context-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #1e293b; color: white; padding: 8px 16px; border-radius: 50px;
            display: flex; gap: 12px; align-items: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 999; opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #context-bar.active { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        .ctx-divider { width: 1px; height: 20px; background: #475569; }
        .ctx-btn {
            background: transparent; border: none; color: #cbd5e1; cursor: pointer;
            padding: 8px; border-radius: 50%; transition: all 0.2s; font-size: 14px;
        }
        .ctx-btn:hover { background: #334155; color: white; transform: translateY(-2px); }
        .ctx-btn.danger:hover { color: #fca5a5; }

        .color-wrapper { width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; overflow: hidden; position: relative; cursor: pointer; }
        .color-wrapper input { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; cursor: pointer; }

        .no-capture { display: none !important; }
        #toast { visibility: hidden; background-color: #333; color: #fff; border-radius: 6px; padding: 12px 24px; position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 2000; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #toast.show { visibility: visible; animation: fadein 0.3s, fadeout 0.3s 2.5s; }
        @keyframes fadein { from {top: 60px; opacity: 0;} to {top: 80px; opacity: 1;} }
        @keyframes fadeout { from {top: 80px; opacity: 1;} to {top: 60px; opacity: 0;} }
    </style>
</head>
<body>

    <div id="top-bar">
        <div class="flex items-center">
            <div class="app-title mr-6">TIER <span>MASTER</span></div>
            <div class="toolbar-group">
                <button class="icon-btn" onclick="undo()" id="btn-undo" title="Ïã§Ìñâ Ï∑®ÏÜå"><i class="fas fa-undo"></i></button>
                <button class="icon-btn" onclick="redo()" id="btn-redo" title="Îã§Ïãú Ïã§Ìñâ"><i class="fas fa-redo"></i></button>
            </div>
            <div class="toolbar-group">
                <button class="icon-btn" onclick="resetZoom()" title="Î∞∞Ïú® Ï¥àÍ∏∞Ìôî"><i class="fas fa-search"></i></button>
            </div>
        </div>
        <div>
            <button onclick="downloadImage()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center gap-2 transition">
                <i class="fas fa-download"></i> Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•
            </button>
        </div>
    </div>

    <div id="toast">ÏïåÎ¶º</div>

    <div class="w-full h-full overflow-auto text-center" style="margin-top: 20px;">
        <div id="capture-container">
            <table id="main-table">
                <thead>
                    <tr>
                        <th class="bg-slate-800 text-white w-[140px]" style="background-color: #1e293b;">
                            <input type="text" class="cell-input head-input" value="TIER \ BRAND">
                        </th>
                        <th class="bg-slate-800 text-white" style="background-color: #1e293b;">
                            <input type="text" class="cell-input head-input" value="ON RUNNING">
                        </th>
                        <th class="bg-slate-800 text-white" style="background-color: #1e293b;">
                            <input type="text" class="cell-input head-input" value="NIKE">
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th class="bg-red-50 text-red-700" style="background-color: #fef2f2; color: #b91c1c;">
                            <input type="text" class="cell-input head-input" value="RACING">
                        </th>
                        <td>
                            <div class="image-drop-zone"><span class="placeholder-text">üì∑ Image</span><img class="uploaded-image"><button class="remove-img-btn" onclick="removeImage(this)">√ó</button></div>
                            <input type="text" class="cell-input model-name" placeholder="Î™®Îç∏Î™Ö">
                            <input type="text" class="cell-input model-desc" placeholder="ÏÑ§Î™Ö">
                        </td>
                        <td>
                            <div class="image-drop-zone"><span class="placeholder-text">üì∑ Image</span><img class="uploaded-image"><button class="remove-img-btn" onclick="removeImage(this)">√ó</button></div>
                            <input type="text" class="cell-input model-name" placeholder="Î™®Îç∏Î™Ö">
                            <input type="text" class="cell-input model-desc" placeholder="ÏÑ§Î™Ö">
                        </td>
                    </tr>
                    <tr>
                        <th class="bg-slate-50 text-slate-600" style="background-color: #f8fafc; color: #475569;">
                            <input type="text" class="cell-input head-input" value="DAILY">
                        </th>
                        <td>
                            <div class="image-drop-zone"><span class="placeholder-text">üì∑ Image</span><img class="uploaded-image"><button class="remove-img-btn" onclick="removeImage(this)">√ó</button></div>
                            <input type="text" class="cell-input model-name" placeholder="Î™®Îç∏Î™Ö">
                            <input type="text" class="cell-input model-desc" placeholder="ÏÑ§Î™Ö">
                        </td>
                        <td>
                            <div class="image-drop-zone"><span class="placeholder-text">üì∑ Image</span><img class="uploaded-image"><button class="remove-img-btn" onclick="removeImage(this)">√ó</button></div>
                            <input type="text" class="cell-input model-name" placeholder="Î™®Îç∏Î™Ö">
                            <input type="text" class="cell-input model-desc" placeholder="ÏÑ§Î™Ö">
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="context-bar">
        <button class="ctx-btn" onclick="insertRow(-1)" title="ÏúÑÎ°ú Ìñâ Ï∂îÍ∞Ä"><i class="fas fa-arrow-up"></i></button>
        <button class="ctx-btn" onclick="insertRow(1)" title="ÏïÑÎûòÎ°ú Ìñâ Ï∂îÍ∞Ä"><i class="fas fa-arrow-down"></i></button>
        <button class="ctx-btn danger" onclick="deleteRow()" title="Ìñâ ÏÇ≠Ï†ú"><i class="fas fa-trash-alt"></i></button>
        
        <div class="ctx-divider"></div>
        
        <button class="ctx-btn" onclick="insertCol(-1)" title="ÏôºÏ™Ω Ïó¥ Ï∂îÍ∞Ä"><i class="fas fa-arrow-left"></i></button>
        <button class="ctx-btn" onclick="insertCol(1)" title="Ïò§Î•∏Ï™Ω Ïó¥ Ï∂îÍ∞Ä"><i class="fas fa-arrow-right"></i></button>
        <button class="ctx-btn danger" onclick="deleteCol()" title="Ïó¥ ÏÇ≠Ï†ú"><i class="fas fa-eraser"></i></button>
        
        <div class="ctx-divider"></div>

        <button class="ctx-btn" onclick="mergeRight()" title="Ïò§Î•∏Ï™Ω Î≥ëÌï©"><i class="fas fa-arrow-right" style="font-size:10px;"></i><i class="fas fa-object-group"></i></button>
        <button class="ctx-btn" onclick="mergeDown()" title="ÏïÑÎûò Î≥ëÌï©"><i class="fas fa-arrow-down" style="font-size:10px;"></i><i class="fas fa-object-group"></i></button>
        <button class="ctx-btn" onclick="splitCell()" title="Î≥ëÌï© Ìï¥Ï†ú"><i class="fas fa-object-ungroup"></i></button>

        <div class="ctx-divider"></div>

        <div class="color-wrapper" title="Î∞∞Í≤ΩÏÉâ"><input type="color" id="bg-color-picker" oninput="changeCellColor(this.value)"></div>
        <button class="ctx-btn" onclick="toggleTextColor()" title="Í∏ÄÏûêÏÉâ Î∞òÏ†Ñ"><i class="fas fa-adjust"></i></button>
    </div>

    <script>
        // --- History System ---
        const historyStack = []; const redoStack = []; const MAX_HISTORY = 30;

        function saveState() {
            document.querySelectorAll('input').forEach(i => i.setAttribute('value', i.value));
            const tableHTML = document.getElementById('main-table').innerHTML;
            historyStack.push(tableHTML);
            if (historyStack.length > MAX_HISTORY) historyStack.shift();
            redoStack.length = 0;
            updateHistoryButtons();
        }

        function undo() {
            if (historyStack.length === 0) return;
            document.querySelectorAll('input').forEach(i => i.setAttribute('value', i.value));
            redoStack.push(document.getElementById('main-table').innerHTML);
            document.getElementById('main-table').innerHTML = historyStack.pop();
            restoreEvents(); deselectCell(); updateHistoryButtons(); showToast("Ïã§Ìñâ Ï∑®ÏÜå");
        }

        function redo() {
            if (redoStack.length === 0) return;
            document.querySelectorAll('input').forEach(i => i.setAttribute('value', i.value));
            historyStack.push(document.getElementById('main-table').innerHTML);
            document.getElementById('main-table').innerHTML = redoStack.pop();
            restoreEvents(); deselectCell(); updateHistoryButtons(); showToast("Îã§Ïãú Ïã§Ìñâ");
        }

        function updateHistoryButtons() {
            document.getElementById('btn-undo').classList.toggle('disabled', historyStack.length === 0);
            document.getElementById('btn-redo').classList.toggle('disabled', redoStack.length === 0);
        }

        // --- Core ---
        let selectedCell = null;
        const contextBar = document.getElementById('context-bar');

        document.addEventListener('DOMContentLoaded', () => {
            restoreEvents(); updateHistoryButtons();
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey||e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
                if ((e.ctrlKey||e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'Z'))) { e.preventDefault(); redo(); }
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('td') && !e.target.closest('th') && !e.target.closest('#context-bar')) deselectCell();
            });
        });

        function restoreEvents() {
            document.querySelectorAll('th, td').forEach(cell => {
                cell.onclick = (e) => {
                    if(e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
                    selectCell(cell);
                };
                cell.addEventListener('dragover', (e) => { e.preventDefault(); cell.style.backgroundColor = '#eff6ff'; });
                cell.addEventListener('dragleave', (e) => { e.preventDefault(); cell.style.backgroundColor = ''; });
                cell.addEventListener('drop', handleDrop);
            });
        }

        function selectCell(cell) {
            if (selectedCell) selectedCell.classList.remove('selected');
            selectedCell = cell; selectedCell.classList.add('selected');
            contextBar.classList.add('active');
            document.getElementById('bg-color-picker').value = rgbToHex(window.getComputedStyle(cell).backgroundColor);
        }
        function deselectCell() {
            if (selectedCell) selectedCell.classList.remove('selected');
            selectedCell = null; contextBar.classList.remove('active');
        }

        // --- Operations (Fixed) ---

        function insertRow(offset) {
            if (!selectedCell) return;
            saveState();
            const tr = selectedCell.parentElement;
            const index = tr.rowIndex + (offset > 0 ? 1 : 0);
            const newRow = document.getElementById('main-table').insertRow(index);
            const colCount = countEffectiveCells(tr);
            
            for(let i=0; i<colCount; i++) {
                const newCell = newRow.insertCell(i);
                // ** ÌïµÏã¨ ÏàòÏ†ï: Ï≤´ Î≤àÏß∏ Ïπ∏(i=0)ÏùÄ Î¨¥Ï°∞Í±¥ Ìã∞Ïñ¥ Î∂ÑÎ•òÏö© th ÏÉùÏÑ± **
                if (i === 0) {
                    newCell.outerHTML = `<th class="bg-slate-50 text-slate-600" style="background-color: #f8fafc; color: #475569;"><input type="text" class="cell-input head-input" value="NEW TIER"></th>`;
                } else {
                    newCell.innerHTML = getModelCellHtml();
                }
            }
            restoreEvents();
        }

        function deleteRow() {
            if (!selectedCell) return;
            saveState();
            if (document.querySelectorAll('tr').length <= 1) return showToast("ÏµúÏÜå 1Í∞úÏùò ÌñâÏùÄ ÌïÑÏöîÌï©ÎãàÎã§.");
            selectedCell.parentElement.remove();
            deselectCell();
        }

        function insertCol(offset) {
            if (!selectedCell) return;
            // ** 1Ïó¥ Î≥¥Ìò∏: 1Ïó¥ ÏôºÏ™ΩÏóêÎäî Ï∂îÍ∞Ä Î∂àÍ∞Ä **
            if (selectedCell.cellIndex === 0 && offset < 0) return showToast("Ìã∞Ïñ¥ Î∂ÑÎ•ò Ïó¥ ÏôºÏ™ΩÏóêÎäî Ï∂îÍ∞ÄÌï† Ïàò ÏóÜÏäµÎãàÎã§.");
            
            saveState();
            const cellIndex = selectedCell.cellIndex;
            const rows = document.querySelectorAll('#main-table tr');
            rows.forEach(row => {
                const newCell = row.insertCell(cellIndex + (offset > 0 ? 1 : 0));
                if (row.parentElement.tagName === 'THEAD') {
                    newCell.outerHTML = `<th class="bg-slate-800 text-white" style="background-color: #1e293b;"><input type="text" class="cell-input head-input" value="NEW"></th>`;
                } else {
                    newCell.innerHTML = getModelCellHtml();
                }
            });
            restoreEvents();
        }

        function deleteCol() {
            if (!selectedCell) return;
            // ** 1Ïó¥ Î≥¥Ìò∏: ÏÇ≠Ï†ú Î∂àÍ∞Ä **
            if (selectedCell.cellIndex === 0) return showToast("Ìã∞Ïñ¥ Î∂ÑÎ•ò(1Ïó¥)Îäî ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§.");
            
            saveState();
            const index = selectedCell.cellIndex;
            const rows = document.querySelectorAll('#main-table tr');
            if (rows[0].cells.length <= 1) return showToast("ÏµúÏÜå 1Ïó¥ÏùÄ ÌïÑÏöîÌï©ÎãàÎã§.");
            rows.forEach(row => { if(row.cells[index]) row.deleteCell(index); });
            deselectCell();
        }

        function mergeRight() {
            if (!selectedCell) return;
            const nextCell = selectedCell.nextElementSibling;
            if (!nextCell) return showToast("Ïò§Î•∏Ï™ΩÏóê ÏÖÄÏù¥ ÏóÜÏäµÎãàÎã§.");
            if ((selectedCell.rowSpan||1) !== (nextCell.rowSpan||1)) return showToast("ÎÜíÏù¥Í∞Ä Îã§Î¶ÖÎãàÎã§.");
            saveState();
            selectedCell.colSpan = (selectedCell.colSpan || 1) + (nextCell.colSpan || 1);
            nextCell.remove();
            showToast("Î≥ëÌï© ÏôÑÎ£å");
        }

        function mergeDown() {
            if (!selectedCell) return;
            const row = selectedCell.parentElement;
            const body = row.parentElement;
            const rows = Array.from(body.children);
            const targetRowIndex = rows.indexOf(row) + (selectedCell.rowSpan || 1);
            if (targetRowIndex >= rows.length) return showToast("ÏïÑÎûòÏóê ÌñâÏù¥ ÏóÜÏäµÎãàÎã§.");
            const targetCell = rows[targetRowIndex].cells[selectedCell.cellIndex]; // Simplified
            if (targetCell) {
                if((selectedCell.colSpan||1) !== (targetCell.colSpan||1)) return showToast("ÎÑàÎπÑÍ∞Ä Îã§Î¶ÖÎãàÎã§.");
                saveState();
                selectedCell.rowSpan = (selectedCell.rowSpan || 1) + (targetCell.rowSpan || 1);
                targetCell.remove();
                showToast("Î≥ëÌï© ÏôÑÎ£å");
            }
        }

        function splitCell() {
            if (!selectedCell) return;
            const colspan = selectedCell.colSpan || 1;
            if (colspan === 1 && (selectedCell.rowSpan||1) === 1) return showToast("Î≥ëÌï©Îêú ÏÖÄÏù¥ ÏïÑÎãôÎãàÎã§.");
            saveState();
            selectedCell.colSpan = 1; selectedCell.rowSpan = 1;
            // Îã®Ïàú Î≥µÍµ¨ (Î†àÏù¥ÏïÑÏõÉ Íπ®Ïßê Î∞©ÏßÄÏö© ÎπàÏÖÄ ÏÇΩÏûÖ)
            if (colspan > 1) {
                const parent = selectedCell.parentElement;
                for(let i=0; i < colspan - 1; i++) {
                    const newCell = parent.insertCell(selectedCell.cellIndex + 1);
                    newCell.innerHTML = getModelCellHtml();
                }
            }
            restoreEvents(); showToast("Î∂ÑÌï† ÏôÑÎ£å");
        }

        // --- Helpers ---
        function changeCellColor(val) { if(!selectedCell)return; saveState(); selectedCell.style.backgroundColor = val; }
        function toggleTextColor() {
            if(!selectedCell)return; saveState();
            const current = window.getComputedStyle(selectedCell).color;
            selectedCell.style.color = (current === 'rgb(255, 255, 255)') ? '#000000' : '#ffffff';
            selectedCell.querySelectorAll('input').forEach(i => i.style.color = 'inherit');
        }
        function getModelCellHtml() {
            return `<div class="image-drop-zone"><span class="placeholder-text">üì∑ Image</span><img class="uploaded-image"><button class="remove-img-btn" onclick="removeImage(this)">√ó</button></div><input type="text" class="cell-input model-name" placeholder="Î™®Îç∏Î™Ö"><input type="text" class="cell-input model-desc" placeholder="ÏÑ§Î™Ö">`;
        }
        function countEffectiveCells(tr) { let c=0; for(let cell of tr.cells) c += cell.colSpan||1; return c; }
        function handleDrop(e) {
            e.preventDefault(); const dt = e.dataTransfer; const files = dt.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                const dropZone = this.querySelector('.image-drop-zone'); if(!dropZone) return;
                saveState();
                const reader = new FileReader();
                reader.onloadend = () => { dropZone.querySelector('img').src = reader.result; dropZone.classList.add('has-image'); };
                reader.readAsDataURL(files[0]);
            }
        }
        function removeImage(btn) { saveState(); const zone = btn.closest('.image-drop-zone'); zone.querySelector('img').src = ''; zone.classList.remove('has-image'); event.stopPropagation(); }
        function rgbToHex(rgb) { if (!rgb || rgb.includes('0, 0, 0, 0')) return '#ffffff'; const a = rgb.match(/\d+/g); return "#" + ((1 << 24) + (+a[0] << 16) + (+a[1] << 8) + +a[2]).toString(16).slice(1); }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.className = "show"; setTimeout(() => t.className = t.className.replace("show", ""), 3000); }
        async function downloadImage() {
            document.getElementById('context-bar').classList.remove('active');
            document.querySelectorAll('.remove-img-btn, .placeholder-text').forEach(el => el.classList.add('no-capture'));
            await new Promise(r => setTimeout(r, 100));
            const canvas = await html2canvas(document.getElementById('capture-container'), { scale: 2, backgroundColor: '#ffffff' });
            const link = document.createElement('a'); link.download = `tier-master-${Date.now()}.png`; link.href = canvas.toDataURL(); link.click();
            document.querySelectorAll('.remove-img-btn, .placeholder-text').forEach(el => el.classList.remove('no-capture'));
        }
    </script>
</body>
</html>